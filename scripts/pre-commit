#!/usr/bin/env bash
set -euo pipefail

# --- Enforce signed commits (lightweight checks before commit creation) ---
if [[ "${ALLOW_UNSIGNED:-0}" != "1" ]]; then
  gpgsign=$(git config --bool commit.gpgsign || echo false)
  signingkey=$(git config --get user.signingkey || echo '')
  if [[ "${gpgsign}" != "true" ]]; then
    echo "[pre-commit] エラー: commit.gpgsign が有効ではありません。\n  対処: git config --global commit.gpgsign true" >&2
    exit 1
  fi
  if [[ -z "${signingkey}" ]]; then
    echo "[pre-commit] エラー: user.signingkey が未設定です。\n  対処: git config --global user.signingkey <YOUR_KEY_ID>" >&2
    exit 1
  fi
fi

# Run formatter
if ! command -v dart >/dev/null 2>&1; then
  echo "dart command not found" >&2
  exit 1
fi

echo "[pre-commit] dart format"
dart format --output=none --set-exit-if-changed .

# Run analyzer
if ! command -v flutter >/dev/null 2>&1; then
  echo "flutter command not found" >&2
  exit 1
fi

echo "[pre-commit] flutter analyze"
flutter analyze

echo "[pre-commit] OK"
